@page "/category/modify"
@page "/category/modify/{Id}"

@attribute [Authorize(Roles = "Customer")]

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                @if(Id == null)
                {
                    <MudText Typo="Typo.h6">Add Category</MudText>
                }
                else
                {
                    <MudText Typo="Typo.h6">Update Category</MudText>
                }
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            <MudTextField @bind-Value="model.CategoryCode" 
                          Variant="Variant.Outlined" 
                          For="@(() => model.CategoryCode)" 
                          Label="Code" 
                          ReadOnly="Id is not null" />

            <MudTextField @bind-Value="model.CategoryDesc" 
                          Variant="Variant.Outlined" 
                          For="@(() => model.CategoryDesc)" 
                          Label="Description" />
        </MudCardContent>

        <MudCardActions Style="display: flex; justify-content: end;">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined" Color="Color.Success">Save</MudButton>
            <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Error">Cancel</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>

@code {
    [Parameter] public string? Id { get; set; }
    private CategoryDto model = new();

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            model = await GetCategory();
        }
    }

    private async Task<CategoryDto> GetCategory()
    {
        var response = await _DataService.GetByIdAsync<Wrapper<CategoryDto>>("category", Id!);
        return response.Data!.Record;
    }

    private async Task OnValidSubmit(EditContext context)
    {
        Result response;

        if (string.IsNullOrWhiteSpace(Id))
        {
            response = await _DataService.PostAsync("category", model);
        }
        else
        {
            response = await _DataService.PutAsync($"category", model);
        }

        if (response.IsSuccess)
        {
            _NavigationManager.NavigateTo("/category/index");
        }
        else
        {
            Console.WriteLine($"Error: {response.Error!.Description}");
        }
    }

    void Cancel()
    {
        _NavigationManager.NavigateTo("/category/index");
    }
}
